<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Login - PlannerTool</title>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;background:#f7f7f7;margin:0;height:100vh;display:flex;align-items:center;justify-content:center}
      .login-box{background:#fff;padding:24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.08);width:360px}
      .login-box h2{margin:0 0 12px}
      .row{margin-bottom:12px}
      label{display:block;margin-bottom:6px;font-size:14px}
      input[type=email]{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px}
      button{padding:10px 14px;border:0;border-radius:4px;background:#2563eb;color:#fff;cursor:pointer}
      .status{margin-top:12px;color:#b91c1c}
    </style>
  </head>
  <body>
    <div class="login-box">
      <h2>Admin Login</h2>
      <div class="row">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="you@example.com" />
      </div>
      <div class="row">
        <button id="loginBtn">Start session</button>
      </div>
      <div id="status" class="status" role="status" aria-live="polite"></div>
    </div>

    <script>
      async function createSession(email){
        try{
          // Include same-origin credentials so Set-Cookie from the server
          // is honored and the browser stores the session cookie.
          const res = await fetch('/api/session', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email }), credentials: 'same-origin' });
          if(!res.ok){
                // Try to parse JSON error detail, otherwise fall back to text
                let msg = 'HTTP ' + res.status;
                try{
                  const j = await res.json();
                  if(j && j.detail) msg = typeof j.detail === 'string' ? j.detail : JSON.stringify(j.detail);
                }catch(e){
                  try{ msg = await res.text(); }catch(_){}
                }
                throw new Error(msg || ('HTTP '+res.status));
              }
              // Success: persist email in local prefs so dataService.init() can auto-create sessions
              try{
                const raw = localStorage.getItem('az_planner:user_prefs:v1');
                const prefs = raw ? JSON.parse(raw) : {};
                prefs['user.email'] = email;
                localStorage.setItem('az_planner:user_prefs:v1', JSON.stringify(prefs));
              }catch(e){}
              // Redirect to admin index which will perform admin check. Use
              // replace to avoid adding the login page to history.
              window.location.replace('/admin');
        }catch(err){
          const st = document.getElementById('status');
          st.textContent = 'Failed to create session: ' + (err.message || err);
        }
      }

      document.getElementById('loginBtn').addEventListener('click', ()=>{
        const email = (document.getElementById('email').value || '').trim();
        if(!email){ document.getElementById('status').textContent = 'Please enter an email.'; return; }
        // Basic client-side email validation to avoid round-trips with invalid input
        const emailRe = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
        if(!emailRe.test(email)){
          document.getElementById('status').textContent = 'Please enter a valid email address.';
          return;
        }
        createSession(email);
      });

      // Allow Enter key to submit
      document.getElementById('email').addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); document.getElementById('loginBtn').click(); } });
    </script>
  </body>
</html>
